<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bitcraft Timer</title>
  <link rel="icon" href="./favicon.png" />
  <meta name="description" content="Calculate working duration and stamina for Bitcraft Online." />
  <style>
    :root{
      --primary:#D9B76E; --primary-dark:#B8934E; --secondary:#7B879F;
      --success:#66E38A; --warning:#E6B34A;
      --background:#0E1325; --surface:#172038; --surface-2:#1C2642;
      --text:#E6E9EF; --text-muted:#A8B0C3;
      --border:#2A3552; --line:#2E3B5F;
      --shadow:0 12px 28px rgba(0,0,0,.36);
      --shadow-lg:0 28px 48px rgba(0,0,0,.38);
      --radius:.75rem;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;color:var(--text);min-height:100vh;background:var(--background);line-height:1.6}
    .container{max-width:1200px;margin:0 auto;padding:1rem}
    header{text-align:center;padding:2rem 0}
    h1{font-size:clamp(1.75rem,4vw,2.5rem);font-weight:800;color:var(--primary);margin-bottom:.5rem;text-shadow:0 2px 12px rgba(217,183,110,.25)}
    .subtitle{font-size:1.125rem;color:var(--text-muted);max-width:640px;margin:0 auto}
    .calculator-grid{display:grid;grid-template-columns:1fr;gap:2rem}
    @media (min-width:768px){.calculator-grid{grid-template-columns:1fr 1fr}}
    .input-card,.result-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:1.5rem}
    .card-title{font-size:1.25rem;font-weight:700;color:var(--text);margin-bottom:1.25rem;display:flex;align-items:center;gap:.5rem}
    .icon{width:1.25rem;height:1.25rem;color:var(--primary)}
    .input-group{margin-bottom:1.25rem}
    label{display:block;font-weight:700;color:var(--text);margin-bottom:.5rem;font-size:.85rem;text-transform:uppercase;letter-spacing:.04em}
    input,select{width:100%;padding:.875rem 1rem;border:2px solid var(--border);border-radius:.5rem;font-size:1rem;background:var(--surface-2);color:var(--text);transition:all .2s ease}
    input:hover,select:hover{border-color:var(--line)}
    input:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(217,183,110,.18)}
    .calculate-btn{width:100%;padding:1rem 1.5rem;background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:#1A1625;border:none;border-radius:.5rem;font-size:1rem;font-weight:800;cursor:pointer;transition:all .2s ease;margin-top:1.5rem;text-transform:uppercase;letter-spacing:.04em}
    .calculate-btn:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg)}
    .calculate-btn:active{transform:translateY(0)}
    .result-card{display:none}
    .result-card.show{display:block}
    .time-display{font-size:2.5rem;font-weight:900;color:var(--primary);text-align:center;margin:1rem 0}
    .seconds-display{text-align:center;color:var(--text-muted);font-size:1rem;margin-bottom:1.25rem}
    .stamina-alert{padding:1rem;border-radius:.5rem;margin:1rem 0;font-weight:700;display:none}
    .stamina-alert.show{display:block}
    .stamina-alert.success{background:rgba(102,227,138,.10);border:1px solid rgba(102,227,138,.32);color:var(--success)}
    .stamina-alert.warning{background:rgba(230,179,74,.10);border:1px solid rgba(230,179,74,.32);color:var(--warning)}
    .calculation-steps{background:#12182F;border-radius:.5rem;padding:1rem;margin-top:1.25rem;border:1px dashed var(--line)}
    .step{display:flex;justify-content:space-between;align-items:center;padding:.5rem 0;border-bottom:1px dashed var(--line);font-size:.9rem}
    .step:last-child{border-bottom:none}
    .step-label{font-weight:800;color:var(--text-muted)}
    .step-value{font-weight:800;color:var(--text)}
    .error{background:rgba(239,107,107,.10);border:1px solid rgba(239,107,107,.35);color:#FFDADA;padding:1rem;border-radius:.5rem;margin-top:1rem;font-weight:700;display:none}
    footer{text-align:center;padding:2rem 0;color:var(--text-muted);font-size:.9rem}
    .alarm-controls{background:#12182F;border:1px dashed var(--line);border-radius:.5rem;padding:.75rem;margin-top:1rem}
    .alarm-row{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;align-items:center}
    @media (max-width:767px){.alarm-row{grid-template-columns:1fr}}
    .inline{display:flex;align-items:center;gap:.5rem}
    .timer-btn{padding:.75rem 1rem;border:none;border-radius:.5rem;background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:#1A1625;font-weight:800;cursor:pointer}
    .timer-btn:disabled{opacity:.5;cursor:not-allowed}
    .muted{color:var(--text-muted);font-size:.9rem}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Bitcraft Timer</h1>
      <p class="subtitle">Calculate working duration, stamina consumption, and pause requirements for different item tiers</p>
    </header>

    <main class="calculator-grid">
      <section class="input-card">
        <h2 class="card-title">
          <svg class="icon" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true"><path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01-.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0z"/></svg>
          Working Parameters
        </h2>

        <div class="input-group">
          <label for="totalEffort">Total Effort</label>
          <input id="totalEffort" type="number" min="0" step="1" placeholder="Enter total effort required" />
        </div>
        <div class="input-group">
          <label for="toolPower">Tool Power</label>
          <input id="toolPower" type="number" min="1" step="1" placeholder="Enter tool power value" />
        </div>
        <div class="input-group">
          <label for="delay">Delay (seconds)</label>
          <input id="delay" type="number" min="0" step="0.01" placeholder="Enter delay between ticks" />
        </div>
        <div class="input-group">
          <label for="tier">Item Tier</label>
          <select id="tier">
            <option value="">Select item tier...</option>
            <option value="1">Tier 1 (0.75 stamina/tick)</option>
            <option value="2">Tier 2 (0.89 stamina/tick)</option>
            <option value="3">Tier 3 (1.03 stamina/tick)</option>
            <option value="4">Tier 4 (1.16 stamina/tick)</option>
            <option value="5">Tier 5 (1.28 stamina/tick)</option>
            <option value="6">Tier 6 (1.41 stamina/tick)</option>
            <option value="7">Tier 7 (1.52 stamina/tick)</option>
            <option value="8">Tier 8 (1.64 stamina/tick)</option>
            <option value="9">Tier 9 (1.75 stamina/tick)</option>
            <option value="10">Tier 10 (1.86 stamina/tick)</option>
          </select>
        </div>
        <div class="input-group">
          <label for="stamina">Max stamina (optional)</label>
          <input id="stamina" type="number" min="1" step="1" placeholder="Enter your stamina" />
        </div>

        <button class="calculate-btn" id="calcBtn">Calculate Working Time</button>
        <div id="error" class="error" role="alert"></div>
      </section>

      <section id="result" class="result-card" aria-live="polite">
        <h2 class="card-title">Working Results</h2>
        <div id="timeDisplay" class="time-display" aria-live="polite"></div>
        <div id="secondsDisplay" class="seconds-display"></div>

        <div id="alarmControls" class="alarm-controls">
          <div class="alarm-row" style="margin-bottom:.5rem">
            <div>
              <label for="countdownSeconds">Countdown (seconds)</label>
              <input id="countdownSeconds" type="number" min="1" step="1" placeholder="e.g., 300 for 5 minutes" />
            </div>
            <div class="inline" style="margin-top:1.75rem">
              <button class="timer-btn" id="startBtn">Start</button>
              <button class="timer-btn" id="pauseBtn" disabled>Pause</button>
              <button class="timer-btn" id="resetBtn" disabled>Reset</button>
            </div>
          </div>
          <div class="alarm-row" style="margin-bottom:.5rem">
            <div class="inline">
              <input type="checkbox" id="loopAlarm" checked />
              <label for="loopAlarm" class="muted">Loop alarm sound</label>
            </div>
            <div class="inline">
              <label for="volume" class="muted">Volume</label>
              <input id="volume" type="range" min="0" max="1" step="0.01" value="0.6" />
              <button class="timer-btn" id="testAlarmBtn" title="Test alarm">Test</button>
              <button class="timer-btn" id="stopAlarmBtn" title="Stop alarm" disabled>Stop</button>
            </div>
          </div>
          <div class="alarm-row">
            <button class="timer-btn" id="syncFromResult" disabled>Set countdown = Total Time</button>
            <div id="liveCountdown" class="muted" aria-live="polite">Timer idle</div>
          </div>
        </div>

        <div id="staminaAlert" class="stamina-alert" role="status"></div>

        <div class="calculation-steps">
          <div class="step"><span class="step-label">Notches Required</span><span class="step-value" id="step1Value"></span></div>
          <div class="step"><span class="step-label">Total Time</span><span class="step-value" id="step2Value"></span></div>
          <div class="step"><span class="step-label">Stamina Info</span><span class="step-value" id="step3Value"></span></div>
        </div>
      </section>
    </main>
  </div>

  <footer><p>&copy; 2025 Bitcraft Timer. No official link with Clockwork Labs.</p></footer>

  <!-- Audio with MP3 fallback (Safari/iOS doesn't play OGG) -->
  <audio id="alarmAudio" preload="auto">
    <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg" />
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" type="audio/mpeg" />
  </audio>

  <script>
    // ===== Utilities =====
    const fmtHMS = (totalSeconds)=>{
      totalSeconds = Math.max(0, Math.round(totalSeconds));
      const h = Math.floor(totalSeconds/3600).toString().padStart(2,'0');
      const m = Math.floor((totalSeconds%3600)/60).toString().padStart(2,'0');
      const s = Math.floor(totalSeconds%60).toString().padStart(2,'0');
      return `${h}:${m}:${s}`;
    };

    const staminaCostByTier = {1:0.75,2:0.89,3:1.03,4:1.16,5:1.28,6:1.41,7:1.52,8:1.64,9:1.75,10:1.86};

    // ===== DOM refs =====
    const els = {
      totalEffort: document.getElementById('totalEffort'),
      toolPower: document.getElementById('toolPower'),
      delay: document.getElementById('delay'),
      tier: document.getElementById('tier'),
      stamina: document.getElementById('stamina'),
      error: document.getElementById('error'),
      result: document.getElementById('result'),
      timeDisplay: document.getElementById('timeDisplay'),
      secondsDisplay: document.getElementById('secondsDisplay'),
      step1Value: document.getElementById('step1Value'),
      step2Value: document.getElementById('step2Value'),
      step3Value: document.getElementById('step3Value'),
      staminaAlert: document.getElementById('staminaAlert'),
      calcBtn: document.getElementById('calcBtn'),
      syncFromResult: document.getElementById('syncFromResult'),
      // Timer controls
      countdownSeconds: document.getElementById('countdownSeconds'),
      startBtn: document.getElementById('startBtn'),
      pauseBtn: document.getElementById('pauseBtn'),
      resetBtn: document.getElementById('resetBtn'),
      loopAlarm: document.getElementById('loopAlarm'),
      volume: document.getElementById('volume'),
      testAlarmBtn: document.getElementById('testAlarmBtn'),
      stopAlarmBtn: document.getElementById('stopAlarmBtn'),
      liveCountdown: document.getElementById('liveCountdown'),
      alarmAudio: document.getElementById('alarmAudio')
    };

    // ===== Calculation logic =====
    let lastTotalSeconds = 0;

    function validateInputs(){
      const totalEffort = Number(els.totalEffort.value);
      const toolPower = Number(els.toolPower.value);
      const delay = Number(els.delay.value);
      const tier = Number(els.tier.value);

      if(!Number.isFinite(totalEffort) || totalEffort <= 0) return 'Please enter a valid Total Effort (> 0).';
      if(!Number.isFinite(toolPower) || toolPower <= 0) return 'Please enter a valid Tool Power (> 0).';
      if(!Number.isFinite(delay) || delay < 0) return 'Please enter a valid Delay (>= 0).';
      if(!staminaCostByTier[tier]) return 'Please select a valid Item Tier.';
      return null;
    }

    function calculateTime(){
      const err = validateInputs();
      if(err){
        els.error.textContent = err;
        els.error.style.display = 'block';
        els.result.classList.remove('show');
        return;
      }
      els.error.style.display = 'none';

      const totalEffort = Number(els.totalEffort.value);
      const toolPower = Number(els.toolPower.value);
      const delay = Number(els.delay.value);
      const tier = Number(els.tier.value);
      const staminaMax = Number(els.stamina.value);

      const notches = Math.ceil(totalEffort / toolPower);
      const totalSeconds = notches * delay;
      lastTotalSeconds = totalSeconds;

      els.timeDisplay.textContent = fmtHMS(totalSeconds);
      els.secondsDisplay.textContent = `${Math.round(totalSeconds)} seconds total`;
      els.step1Value.textContent = `${notches} ticks`;
      els.step2Value.textContent = `${fmtHMS(totalSeconds)} (${Math.round(totalSeconds)}s)`;

      const costPerTick = staminaCostByTier[tier];
      const totalStamina = +(notches * costPerTick).toFixed(2);
      let staminaMsg = `Cost ${costPerTick} per tick × ${notches} = ${totalStamina}`;

      els.staminaAlert.className = 'stamina-alert';
      els.staminaAlert.style.display = 'none';

      if(Number.isFinite(staminaMax) && staminaMax > 0){
        if(staminaMax >= totalStamina){
          els.staminaAlert.textContent = `✔ You have enough stamina. Consumption: ${totalStamina}/${staminaMax}.`;
          els.staminaAlert.classList.add('show','success');
          staminaMsg += ` — within your ${staminaMax} stamina.`;
        } else {
          const doableTicks = Math.floor(staminaMax / costPerTick);
          const doableTime = doableTicks * delay;
          els.staminaAlert.innerHTML = `⚠ Not enough stamina. Need <b>${totalStamina}</b>, you have <b>${staminaMax}</b>.<br>`+
            `You can work ~<b>${doableTicks}</b> ticks (~<b>${fmtHMS(doableTime)}</b>) before resting.`;
          els.staminaAlert.classList.add('show','warning');
          staminaMsg += ` — exceeds your ${staminaMax} stamina.`;
        }
      }
      els.step3Value.textContent = staminaMsg;

      els.result.classList.add('show');
      els.syncFromResult.disabled = !(totalSeconds > 0);
    }

    els.calcBtn.addEventListener('click', calculateTime);

    // ===== Countdown + Alarm logic =====
    let timerInterval = null;
    let remaining = 0;
    let running = false;
    let alarmRinging = false;
    let audioCtx = null; // WebAudio fallback

    function updateLiveCountdown(){
      els.liveCountdown.textContent = running
        ? `Time left: ${fmtHMS(remaining)} (${Math.max(0, Math.round(remaining))}s)`
        : (remaining>0 ? `Paused at ${fmtHMS(remaining)}` : 'Timer idle');
    }

    function setButtons(){
      els.startBtn.disabled = running || remaining <= 0;
      els.pauseBtn.disabled = !running;
      els.resetBtn.disabled = remaining <= 0 && !running;
      els.stopAlarmBtn.disabled = !alarmRinging;
    }

    function tick(){
      remaining -= 1;
      if(remaining <= 0){
        clearInterval(timerInterval);
        timerInterval = null;
        running = false;
        remaining = 0;
        updateLiveCountdown();
        setButtons();
        ringAlarm();
        return;
      }
      updateLiveCountdown();
    }

    function startTimer(){
      const inputSeconds = Number(els.countdownSeconds.value);
      if(!running && remaining <= 0){
        if(!Number.isFinite(inputSeconds) || inputSeconds <= 0){
          els.liveCountdown.textContent = 'Enter a valid countdown seconds > 0';
          return;
        }
        remaining = Math.round(inputSeconds);
      }
      if(running) return;
      running = true;
      updateLiveCountdown();
      setButtons();
      timerInterval = setInterval(tick, 1000);

      // On the first user gesture, resume AudioContext if needed
      try{
        if(!audioCtx){ audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        if(audioCtx.state === 'suspended'){ audioCtx.resume(); }
      }catch(e){}
    }

    function pauseTimer(){
      if(!running) return;
      running = false;
      if(timerInterval){ clearInterval(timerInterval); timerInterval = null; }
      updateLiveCountdown();
      setButtons();
    }

    function resetTimer(){
      running = false;
      if(timerInterval){ clearInterval(timerInterval); timerInterval = null; }
      remaining = 0;
      updateLiveCountdown();
      setButtons();
    }

    function playWebAudioBeep(durationMs=2500){
      try{
        if(!audioCtx){ audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        if(audioCtx.state === 'suspended'){ audioCtx.resume(); }
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = 'square';
        o.frequency.value = 880; // A5
        g.gain.setValueAtTime(0.001, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.2, audioCtx.currentTime + 0.05);
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + durationMs/1000);
        o.connect(g).connect(audioCtx.destination);
        o.start();
        o.stop(audioCtx.currentTime + durationMs/1000);
        alarmRinging = true;
        setButtons();
        // auto-clear after duration
        setTimeout(()=>{ alarmRinging = false; setButtons(); }, durationMs);
      }catch(e){ /* ignore */ }
    }

    function ringAlarm(){
      const audio = els.alarmAudio;
      audio.loop = els.loopAlarm.checked;
      audio.volume = Number(els.volume.value);
      audio.currentTime = 0;

      const tryPlay = () => audio.play().then(()=>{
        alarmRinging = true;
        setButtons();
      }).catch(()=>{
        // Fallback if autoplay or codec fails
        playWebAudioBeep(3000);
      });

      // If source not yet ready, wait a tick
      if(audio.readyState < 2){ // HAVE_CURRENT_DATA
        const onCanPlay = ()=>{ audio.removeEventListener('canplay', onCanPlay); tryPlay(); };
        audio.addEventListener('canplay', onCanPlay);
        audio.load();
      } else {
        tryPlay();
      }
    }

    function stopAlarm(){
      const audio = els.alarmAudio;
      try{ audio.pause(); audio.currentTime = 0; }catch(e){}
      alarmRinging = false;
      setButtons();
    }

    // Timer control events
    els.startBtn.addEventListener('click', startTimer);
    els.pauseBtn.addEventListener('click', pauseTimer);
    els.resetBtn.addEventListener('click', resetTimer);
    els.testAlarmBtn.addEventListener('click', ()=>{
      ringAlarm();
      if(!els.loopAlarm.checked){ setTimeout(stopAlarm, 3000); }
    });
    els.stopAlarmBtn.addEventListener('click', stopAlarm);
    els.volume.addEventListener('input', ()=>{ els.alarmAudio.volume = Number(els.volume.value); });

    // Sync button sets countdown to the computed total time
    els.syncFromResult.addEventListener('click', ()=>{
      if(lastTotalSeconds > 0){
        els.countdownSeconds.value = Math.round(lastTotalSeconds);
        els.liveCountdown.textContent = `Countdown set to ${fmtHMS(lastTotalSeconds)}.`;
      }
    });

    // Enter key triggers calculation
    ['totalEffort','toolPower','delay','tier','stamina'].forEach(id=>{
      const node = document.getElementById(id);
      node.addEventListener('keydown', (e)=>{ if(e.key==='Enter') calculateTime(); });
    });

    // Preload audio on first interaction to satisfy mobile autoplay rules
    document.addEventListener('click', function once(){
      const a = els.alarmAudio; try{ a.load(); }catch(e){}
      document.removeEventListener('click', once, {capture:false});
    }, {capture:false, once:true});
  </script>
</body>
</html>
